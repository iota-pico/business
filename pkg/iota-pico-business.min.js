!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@iota-pico/data/dist/data/trits"),require("@iota-pico/data/dist/data/trytes"),require("@iota-pico/core/dist/helpers/arrayHelper"),require("@iota-pico/core/dist/helpers/objectHelper"),require("@iota-pico/crypto/dist/factories/spongeFactory"),require("@iota-pico/data/dist/data/address"),require("@iota-pico/data/dist/data/hash"),require("@iota-pico/crypto/dist/hash/iss"),require("@iota-pico/data/dist/data/bundle"),require("@iota-pico/data/dist/data/signatureMessageFragment"),require("@iota-pico/data/dist/data/tag"),require("@iota-pico/data/dist/data/transaction"),require("@iota-pico/core/dist/helpers/numberHelper"),require("@iota-pico/core/dist/services/timeService"),require("@iota-pico/data/dist/data/transfer"),require("@iota-pico/core/dist/error/coreError"),require("@iota-pico/data/dist/data/tryteNumber"),require("@iota-pico/core/dist/loggers/nullLogger"),require("@iota-pico/core/dist/services/backgroundTaskService"),require("@iota-pico/crypto/dist/helpers/transactionHelper"),require("@iota-pico/data/dist/data/addressSecurity"),require("@iota-pico/data/dist/data/input"),require("@iota-pico/crypto/dist/error/cryptoError")):"function"==typeof define&&define.amd?define("@iota-pico/business",["@iota-pico/data/dist/data/trits","@iota-pico/data/dist/data/trytes","@iota-pico/core/dist/helpers/arrayHelper","@iota-pico/core/dist/helpers/objectHelper","@iota-pico/crypto/dist/factories/spongeFactory","@iota-pico/data/dist/data/address","@iota-pico/data/dist/data/hash","@iota-pico/crypto/dist/hash/iss","@iota-pico/data/dist/data/bundle","@iota-pico/data/dist/data/signatureMessageFragment","@iota-pico/data/dist/data/tag","@iota-pico/data/dist/data/transaction","@iota-pico/core/dist/helpers/numberHelper","@iota-pico/core/dist/services/timeService","@iota-pico/data/dist/data/transfer","@iota-pico/core/dist/error/coreError","@iota-pico/data/dist/data/tryteNumber","@iota-pico/core/dist/loggers/nullLogger","@iota-pico/core/dist/services/backgroundTaskService","@iota-pico/crypto/dist/helpers/transactionHelper","@iota-pico/data/dist/data/addressSecurity","@iota-pico/data/dist/data/input","@iota-pico/crypto/dist/error/cryptoError"],t):"object"==typeof exports?exports["@iota-pico/business"]=t(require("@iota-pico/data/dist/data/trits"),require("@iota-pico/data/dist/data/trytes"),require("@iota-pico/core/dist/helpers/arrayHelper"),require("@iota-pico/core/dist/helpers/objectHelper"),require("@iota-pico/crypto/dist/factories/spongeFactory"),require("@iota-pico/data/dist/data/address"),require("@iota-pico/data/dist/data/hash"),require("@iota-pico/crypto/dist/hash/iss"),require("@iota-pico/data/dist/data/bundle"),require("@iota-pico/data/dist/data/signatureMessageFragment"),require("@iota-pico/data/dist/data/tag"),require("@iota-pico/data/dist/data/transaction"),require("@iota-pico/core/dist/helpers/numberHelper"),require("@iota-pico/core/dist/services/timeService"),require("@iota-pico/data/dist/data/transfer"),require("@iota-pico/core/dist/error/coreError"),require("@iota-pico/data/dist/data/tryteNumber"),require("@iota-pico/core/dist/loggers/nullLogger"),require("@iota-pico/core/dist/services/backgroundTaskService"),require("@iota-pico/crypto/dist/helpers/transactionHelper"),require("@iota-pico/data/dist/data/addressSecurity"),require("@iota-pico/data/dist/data/input"),require("@iota-pico/crypto/dist/error/cryptoError")):e.IotaPicoBusiness=t(e["@iota-pico/data/dist/data/trits"],e["@iota-pico/data/dist/data/trytes"],e["@iota-pico/core/dist/helpers/arrayHelper"],e["@iota-pico/core/dist/helpers/objectHelper"],e["@iota-pico/crypto/dist/factories/spongeFactory"],e["@iota-pico/data/dist/data/address"],e["@iota-pico/data/dist/data/hash"],e["@iota-pico/crypto/dist/hash/iss"],e["@iota-pico/data/dist/data/bundle"],e["@iota-pico/data/dist/data/signatureMessageFragment"],e["@iota-pico/data/dist/data/tag"],e["@iota-pico/data/dist/data/transaction"],e["@iota-pico/core/dist/helpers/numberHelper"],e["@iota-pico/core/dist/services/timeService"],e["@iota-pico/data/dist/data/transfer"],e["@iota-pico/core/dist/error/coreError"],e["@iota-pico/data/dist/data/tryteNumber"],e["@iota-pico/core/dist/loggers/nullLogger"],e["@iota-pico/core/dist/services/backgroundTaskService"],e["@iota-pico/crypto/dist/helpers/transactionHelper"],e["@iota-pico/data/dist/data/addressSecurity"],e["@iota-pico/data/dist/data/input"],e["@iota-pico/crypto/dist/error/cryptoError"])}("undefined"!=typeof self?self:this,function(e,t,r,n,a,s,i,o,u,c,l,f,d,p,h,g,y,b,T,m,v,w,x){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=21)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}Object.defineProperty(t,"__esModule",{value:!0});var o=r(22),u=function(e){function t(e,r,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(i=a(this,s(t).call(this,e,r,n))).domain="Business",i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}(t,o.CoreError),t}();t.BusinessError=u},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t){e.exports=s},function(e,t){e.exports=i},function(e,t,r){"use strict";function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(3),s=r(4),i=r(5),o=r(9),u=r(6),c=r(10),l=r(7),f=r(11),d=r(12),p=r(13),h=r(0),g=r(23),y=r(1),b=r(17),T=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,r){r&&n(e,r)}(e,0,[{key:"isValid",value:function(e){var t=!1;if(s.ObjectHelper.isType(e,c.Bundle)&&a.ArrayHelper.isTyped(e.transactions,p.Transaction)){var r=0,n=i.SpongeFactory.instance().create("kerl");n.initialize();var u=[];t=!0;for(var l=0;l<e.transactions.length&&t;l++){var d=e.transactions[l];if(r+=d.value.toNumber(),d.currentIndex.toNumber()!==l)t=!1;else{var g=d.toTrytes(),y=h.Trits.fromTrytes(g.sub(f.SignatureMessageFragment.LENGTH,162)).toArray();if(n.absorb(y,0,y.length),d.value.toNumber()<0){for(var b={address:d.address,signatureMessageFragments:[d.signatureMessageFragment]},T=l;T<e.transactions.length-1;T++){var m=e.transactions[T+1];m.address.toTrytes().toString()===d.address.toTrytes().toString()&&0===m.value.toNumber()&&b.signatureMessageFragments.push(m.signatureMessageFragment)}u.push(b)}}}if(0!==r)t=!1;else{var v=new Int8Array(n.getConstant("HASH_LENGTH"));n.squeeze(v,0,v.length);var w=h.Trits.fromArray(v).toTrytes().toString(),x=e.transactions[0].bundle;if(w!==x.toTrytes().toString())t=!1;else if(e.transactions[e.transactions.length-1].currentIndex.toNumber()!==e.transactions[e.transactions.length-1].lastIndex.toNumber())t=!1;else for(var k=0;k<u.length&&t;k++)o.ISS.validateSignatures(u[k].address,u[k].signatureMessageFragments,x)||(t=!1)}}return t}},{key:"validateSignatures",value:function(e,t){var r=!1;if(s.ObjectHelper.isType(e,c.Bundle)&&a.ArrayHelper.isTyped(e.transactions,p.Transaction)&&s.ObjectHelper.isType(t,u.Address)){for(var n,i=[],l=t.toTrytes().toString(),d=0;d<e.transactions.length;d++)if(e.transactions[d].address.toTrytes().toString()===l){if(n=e.transactions[d].bundle,e.transactions[d].signatureMessageFragment.toTrytes().toString()===f.SignatureMessageFragment.EMPTY.toTrytes().toString())break;i.push(e.transactions[d].signatureMessageFragment)}n&&(r=o.ISS.validateSignatures(t,i,n))}return r}},{key:"prepareBundle",value:function(e,t){for(var r,n=new c.Bundle,a=0,s=[],i=0;i<t.length;i++){var o=1,u=t[i].message.toString();if(u.length>f.SignatureMessageFragment.LENGTH){o+=Math.floor(u.length/f.SignatureMessageFragment.LENGTH);for(var l=u;l;){var d=l.slice(0,f.SignatureMessageFragment.LENGTH);l=l.slice(f.SignatureMessageFragment.LENGTH,l.length);for(var p=0;d.length<f.SignatureMessageFragment.LENGTH;p++)d+="9";s.push(f.SignatureMessageFragment.fromTrytes(y.Trytes.fromString(d)))}}else{var h="";u&&(h=u.slice(0,f.SignatureMessageFragment.LENGTH));for(var g=0;h.length<f.SignatureMessageFragment.LENGTH;g++)h+="9";s.push(f.SignatureMessageFragment.fromTrytes(y.Trytes.fromString(h)))}var b=Math.floor(e.msSinceEpoch()/1e3);r=t[i].tag,n.addTransactions(o,t[i].address,t[i].value,t[i].tag,b),a+=t[i].value}return{bundle:n,totalValue:a,lastTag:r,signatureMessageFragments:s}}},{key:"signInputs",value:function(t,r,n,a,s,i){e.finalizeBundle(r),r.addSignatureMessageFragments(a);for(var u=0;u<r.transactions.length;u++)if(r.transactions[u].value.toNumber()<0){for(var c=r.transactions[u].address.toTrytes().toString(),l=void 0,f=void 0,d=0;d<s.length;d++)if(s[d].address.toTrytes().toString()===c){l=s[d].keyIndex,f=s[d].security?s[d].security:n.security;break}var p=o.ISS.key(t,l,f);e.signTransactions(r,u,0,p,c,f)}i&&new b.HmacCurl(n.hmacKey).addHMAC(r)}},{key:"signTransactions",value:function(e,t,r,n,a,s){for(var i=e.transactions[t].bundle,u=o.ISS.normalizedBundle(i),c=[],l=0;l<3;l++)c[l]=u.slice(27*l,27*(l+1));var d=n.slice(0,6561),p=c[r],g=o.ISS.signatureMessageFragment(p,d);e.transactions[t].signatureMessageFragment=f.SignatureMessageFragment.fromTrytes(h.Trits.fromArray(g).toTrytes());for(var y=1;y<s;y++)if(e.transactions[t+y].address.toTrytes().toString()===a&&0===e.transactions[t+y].value.toNumber()){var b=n.slice(6561*y,6561*(y+1)),T=c[y],m=o.ISS.signatureMessageFragment(T,b);e.transactions[t+y].signatureMessageFragment=f.SignatureMessageFragment.fromTrytes(h.Trits.fromArray(m).toTrytes())}}},{key:"finalizeBundle",value:function(e){if(e.transactions.length>0)for(var t=!1;!t;){var r=i.SpongeFactory.instance().create("kerl");r.initialize();for(var n=0;n<e.transactions.length;n++){e.transactions[n].currentIndex=g.TryteNumber.fromNumber(n),e.transactions[n].lastIndex=g.TryteNumber.fromNumber(e.transactions.length-1);var a=h.Trits.fromTrytes(y.Trytes.fromString(e.transactions[n].address.toTrytes().toString()+e.transactions[n].value.toTrytes().toString()+p.Transaction.CHECK_VALUE+e.transactions[n].obsoleteTag.toTrytes().toString()+e.transactions[n].timestamp.toTrytes().toString()+e.transactions[n].currentIndex.toTrytes().toString()+e.transactions[n].lastIndex.toTrytes().toString())).toArray();r.absorb(a,0,a.length)}var s=new Int8Array(r.getConstant("HASH_LENGTH"));r.squeeze(s,0,s.length);for(var u=l.Hash.fromTrytes(h.Trits.fromArray(s).toTrytes()),c=0;c<e.transactions.length;c++)e.transactions[c].bundle=u;if(-1!==o.ISS.normalizedBundle(u).indexOf(13)){var f=h.Trits.add(h.Trits.fromTrytes(e.transactions[0].obsoleteTag.toTrytes()),h.Trits.fromNumberArray([1]));e.transactions[0].obsoleteTag=d.Tag.fromTrytes(f.toTrytes())}else t=!0}}}]),e}();T.NUMBER_OF_FRAGMENT_CHUNKS=27,t.BundleHelper=T},function(e,t){e.exports=o},function(e,t){e.exports=u},function(e,t){e.exports=c},function(e,t){e.exports=l},function(e,t){e.exports=f},function(e,t,r){e.exports=r(25)},function(e,t){e.exports=d},function(e,t,r){"use strict";function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(5),s=r(0),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,r){r&&n(e,r)}(e,0,[{key:"createChecksum",value:function(e,t){var r=a.SpongeFactory.instance().create("kerl");r.initialize(),r.absorb(e,0,e.length);var n=new Int8Array(r.getConstant("HASH_LENGTH"));return r.squeeze(n,0,n.length),s.Trits.fromArray(n).toTrytes().toString().substring(81-t,81)}}]),e}();t.AddressHelper=i},function(e,t,r){"use strict";function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(5),s=r(11),i=r(0),o=r(1),u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._keyTrits=i.Trits.fromTrytes(t).toArray()}return function(e,t,r){t&&n(e.prototype,t)}(e,[{key:"addHMAC",value:function(t){for(var r=a.SpongeFactory.instance().create("curl",e.HMAC_ROUNDS),n=r.getConstant("HASH_LENGTH"),u=this._keyTrits,c=0;c<t.transactions.length;c++)if(t.transactions[c].value.toNumber()>0){var l=i.Trits.fromTrytes(t.transactions[c].bundle.toTrytes()).toArray(),f=new Int8Array(n);r.initialize(),r.absorb(u,0,u.length),r.absorb(l,0,l.length),r.squeeze(f,0,f.length);var d=i.Trits.fromArray(f).toTrytes().toString(),p=t.transactions[c].signatureMessageFragment.toTrytes().toString().substring(81,s.SignatureMessageFragment.LENGTH);t.transactions[c].signatureMessageFragment=s.SignatureMessageFragment.fromTrytes(o.Trytes.fromString(d+p))}}}]),e}();u.HMAC_ROUNDS=27,t.HmacCurl=u},function(e,t,r){"use strict";function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var a=r(3),s=r(4),i=r(5),o=r(6),u=r(0),c=r(1),l=r(2),f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._kerl=i.SpongeFactory.instance().create("kerl"),this._hashLength=this._kerl.getConstant("HASH_LENGTH"),this._kerl.initialize()}return function(e,t,r){t&&n(e.prototype,t)}(e,[{key:"absorb",value:function(e){if(!a.ArrayHelper.isTyped(e,c.Trytes))throw new l.BusinessError("The digests should be an array of type Trytes");for(var t=0;t<e.length;t++){var r=u.Trits.fromTrytes(e[t]).toArray();this._kerl.absorb(r,0,r.length)}}},{key:"finalize",value:function(e){s.ObjectHelper.isEmpty(e)||this.absorb(e);var t=new Int8Array(this._hashLength);return this._kerl.squeeze(t,0,t.length),o.Address.fromTrytes(u.Trits.fromArray(t).toTrytes())}}]),e}();t.MultiSigAddress=f},function(e,t){e.exports=p},function(e,t){e.exports=h},function(e,t,r){"use strict";function n(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0}),n(r(2)),n(r(16)),n(r(8)),n(r(18)),n(r(24)),n(r(17)),n(r(27))},function(e,t){e.exports=g},function(e,t){e.exports=y},function(e,t,r){"use strict";var n=function(e){return e&&e.__esModule?e:{default:e}}(r(14));function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var s=r(3),i=r(15),o=r(4),u=r(19),c=r(9),l=r(6),f=r(10),d=r(7),p=r(11),h=r(12),g=r(13),y=r(20),b=r(0),T=r(1),m=r(2),v=r(8),w=r(18),x=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new u.TimeService;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._apiClient=t,this._timeService=r}return function(e,t,r){t&&a(e.prototype,t),r&&a(e,r)}(e,[{key:"prepareTransfer",value:function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var s=e.apply(t,r);function i(e,t){try{var r=s[e](t),i=r.value}catch(e){return void a(e)}r.done?n(i):Promise.resolve(i).then(o,u)}function o(e){i("next",e)}function u(e){i("throw",e)}o()})}}(n.default.mark(function e(t,r,a,u,c){var f,d,p,g,b,w;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o.ObjectHelper.isType(t,l.Address)){e.next=2;break}throw new m.BusinessError("The address should be an object of type Address");case 2:if(i.NumberHelper.isInteger(r)&&!(r<0)){e.next=4;break}throw new m.BusinessError("The securitySum should be a number >= 0");case 4:if(i.NumberHelper.isInteger(a)&&!(a<0)){e.next=6;break}throw new m.BusinessError("The balance should be a number >= 0");case 6:if(s.ArrayHelper.isTyped(u,y.Transfer)){e.next=8;break}throw new m.BusinessError("The transfers should be an array of type Transfer");case 8:if(o.ObjectHelper.isEmpty(c)||o.ObjectHelper.isType(c,l.Address)){e.next=10;break}throw new m.BusinessError("The remainderAddress should be an object of type Address");case 10:if(f=T.Trytes.fromString(""),u.forEach(function(e){e.message=e.message?e.message:f,e.tag=e.tag||h.Tag.EMPTY}),0!==(d=v.BundleHelper.prepareBundle(this._timeService,u)).totalValue){e.next=17;break}throw new m.BusinessError("The total transfer value is 0, the transfer does not require a signature");case 17:if(0!==(p=a)){e.next=24;break}return g={addresses:[t.toTrytes().toString()],threshold:100},e.next=22,this._apiClient.getBalances(g);case 22:b=e.sent,p=parseInt(b.balances[0],10);case 24:if(!(d.totalValue>p)){e.next=26;break}throw new m.BusinessError("Not enough balance to satisfy the value",{totalValue:d.totalValue,totalBalance:p});case 26:if(w=Math.floor(this._timeService.msSinceEpoch()/1e3),d.bundle.addTransactions(r,t,-p,d.lastTag,w),!(p>d.totalValue)){e.next=32;break}if(!o.ObjectHelper.isEmpty(c)){e.next=31;break}throw new m.BusinessError("Transfer has remainder but no remainder address was provided");case 31:d.bundle.addTransactions(1,c,p-d.totalValue,d.lastTag,w);case 32:v.BundleHelper.finalizeBundle(d.bundle),d.bundle.addSignatureMessageFragments(d.signatureMessageFragments);case 34:return e.abrupt("return",d.bundle);case 35:case"end":return e.stop()}},e,this)}));return function(t,r,n,a,s){return e.apply(this,arguments)}}()}],[{key:"getKey",value:function(e,t,r){if(!o.ObjectHelper.isType(e,d.Hash))throw new m.BusinessError("The seed should be an object of type Hash");if(!i.NumberHelper.isInteger(t)||t<0)throw new m.BusinessError("The index should be a number >= 0");if(!i.NumberHelper.isInteger(r)||r<1||r>3)throw new m.BusinessError("The security must be between 1 and 3",{security:r});return b.Trits.fromArray(c.ISS.key(e,t,r)).toTrytes()}},{key:"getDigest",value:function(e,t,r){if(!o.ObjectHelper.isType(e,d.Hash))throw new m.BusinessError("The seed should be an object of type Hash");if(!i.NumberHelper.isInteger(t)||t<0)throw new m.BusinessError("The index should be a number >= 0");if(!i.NumberHelper.isInteger(r)||r<1||r>3)throw new m.BusinessError("The security must be between 1 and 3",{security:r});var n=c.ISS.key(e,t,r);return b.Trits.fromArray(c.ISS.digests(n)).toTrytes()}},{key:"validateAddress",value:function(e,t){if(!o.ObjectHelper.isType(e,l.Address))throw new m.BusinessError("The address should be an object of type Address");if(!s.ArrayHelper.isTyped(t,T.Trytes))throw new m.BusinessError("The digests should be an array of type Trytes");return e.toTrytes().toString()===(new w.MultiSigAddress).finalize(t).toTrytes().toString()}},{key:"addSignature",value:function(e,t,r){if(!o.ObjectHelper.isType(e,f.Bundle))throw new m.BusinessError("The bundle should be an object of type Bundle");if(!s.ArrayHelper.isTyped(e.transactions,g.Transaction))throw new m.BusinessError("The bundle.transactions should be an array of type Transaction");if(!o.ObjectHelper.isType(t,l.Address))throw new m.BusinessError("The address should be an object of type Address");if(!o.ObjectHelper.isType(r,T.Trytes))throw new m.BusinessError("The key should be an object of type Trytes");for(var n=b.Trits.fromTrytes(r).toArray(),a=n.length/3/2187,i=0,u=t.toTrytes().toString(),c=0;c<e.transactions.length;c++)if(e.transactions[c].address.toTrytes().toString()===u){if(e.transactions[c].signatureMessageFragment.toTrytes().toString()===p.SignatureMessageFragment.EMPTY.toTrytes().toString()){v.BundleHelper.signTransactions(e,c,i%3,n,u,a);break}i++}}}]),e}();t.MultiSigClient=x},function(e,t,r){var n=function(){return this}()||Function("return this")(),a=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,s=a&&n.regeneratorRuntime;if(n.regeneratorRuntime=void 0,e.exports=r(26),a)n.regeneratorRuntime=s;else try{delete n.regeneratorRuntime}catch(e){n.regeneratorRuntime=void 0}},function(e,t){!function(t){"use strict";var r,n=Object.prototype,a=n.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},i=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",u=s.toStringTag||"@@toStringTag",c="object"==typeof e,l=t.regeneratorRuntime;if(l)c&&(e.exports=l);else{(l=t.regeneratorRuntime=c?e.exports:{}).wrap=v;var f="suspendedStart",d="suspendedYield",p="executing",h="completed",g={},y={};y[i]=function(){return this};var b=Object.getPrototypeOf,T=b&&b(b(I([])));T&&T!==n&&a.call(T,i)&&(y=T);var m=S.prototype=x.prototype=Object.create(y);k.prototype=m.constructor=S,S.constructor=k,S[u]=k.displayName="GeneratorFunction",l.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===k||"GeneratorFunction"===(t.displayName||t.name))},l.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,S):(e.__proto__=S,u in e||(e[u]="GeneratorFunction")),e.prototype=Object.create(m),e},l.awrap=function(e){return{__await:e}},H(E.prototype),E.prototype[o]=function(){return this},l.AsyncIterator=E,l.async=function(e,t,r,n){var a=new E(v(e,t,r,n));return l.isGeneratorFunction(t)?a:a.next().then(function(e){return e.done?e.value:a.next()})},H(m),m[u]="Generator",m[i]=function(){return this},m.toString=function(){return"[object Generator]"},l.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},l.values=I,j.prototype={constructor:j,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(A),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,a){return o.type="throw",o.arg=e,t.next=n,a&&(t.method="next",t.arg=r),!!a}for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=a.call(i,"catchLoc"),c=a.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var s=n;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var i=s?s.completion:{};return i.type=e,i.arg=t,s?(this.method="next",this.next=s.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),A(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;A(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=r),g}}}function v(e,t,r,n){var a=t&&t.prototype instanceof x?t:x,s=Object.create(a.prototype),i=new j(n||[]);return s._invoke=function(e,t,r){var n=f;return function(a,s){if(n===p)throw new Error("Generator is already running");if(n===h){if("throw"===a)throw s;return O()}for(r.method=a,r.arg=s;;){var i=r.delegate;if(i){var o=_(i,r);if(o){if(o===g)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===f)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=p;var u=w(e,t,r);if("normal"===u.type){if(n=r.done?h:d,u.arg===g)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=h,r.method="throw",r.arg=u.arg)}}}(e,r,i),s}function w(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function x(){}function k(){}function S(){}function H(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function E(e){var t;this._invoke=function(r,n){function s(){return new Promise(function(t,s){!function t(r,n,s,i){var o=w(e[r],e,n);if("throw"!==o.type){var u=o.arg,c=u.value;return c&&"object"==typeof c&&a.call(c,"__await")?Promise.resolve(c.__await).then(function(e){t("next",e,s,i)},function(e){t("throw",e,s,i)}):Promise.resolve(c).then(function(e){u.value=e,s(u)},i)}i(o.arg)}(r,n,t,s)})}return t=t?t.then(s,s):s()}}function _(e,t){var n=e.iterator[t.method];if(n===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=r,_(e,t),"throw"===t.method))return g;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return g}var a=w(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,g;var s=a.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=r),t.delegate=null,g):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,g)}function B(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function j(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(B,this),this.reset(!0)}function I(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function t(){for(;++n<e.length;)if(a.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=r,t.done=!0,t};return s.next=s}}return{next:O}}function O(){return{value:r,done:!0}}}(function(){return this}()||Function("return this")())},function(e,t,r){"use strict";var n=function(e){return e&&e.__esModule?e:{default:e}}(r(14));function a(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var s=e.apply(t,r);function i(e,t){try{var r=s[e](t),i=r.value}catch(e){return void a(e)}r.done?n(i):Promise.resolve(i).then(o,u)}function o(e){i("next",e)}function u(e){i("throw",e)}o()})}}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var i=r(3),o=r(15),u=r(4),c=r(28),l=r(29),f=r(19),d=r(9),p=r(30),h=r(6),g=r(31),y=r(10),b=r(7),T=r(32),m=r(12),v=r(13),w=r(20),x=r(0),k=r(1),S=r(2),H=r(16),E=r(8),_=r(33),B=function(){function e(t,r,n,a,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u.ObjectHelper.isEmpty(t))throw new S.BusinessError("The apiClient must not be empty");this._apiClient=t,this._proofOfWork=r||new _.ProofOfWorkApi(t),this._timeService=n||new f.TimeService,this._backgroundTaskService=a||new l.BackgroundTaskService,this._logger=s||new c.NullLogger}return function(e,t,r){t&&s(e.prototype,t)}(e,[{key:"getTransactionsInProgress",value:function(){var e=a(n.default.mark(function e(){var t,r;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._logger.info("===> TransactionClient::getTransactionsInProgress"),e.next=3,this._apiClient.getTips();case 3:if(!(t=e.sent)||!t.hashes){e.next=10;break}return r=t.hashes.map(function(e){return b.Hash.fromTrytes(k.Trytes.fromString(e))}),this._logger.info("<=== TransactionClient::getTransactionsInProgress",r),e.abrupt("return",r);case 10:return this._logger.info("<=== TransactionClient::getTransactionsInProgress",[]),e.abrupt("return",[]);case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"findTransactions",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var o,u,c,l,f,d,p;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::findTransactions",t,r,a,s),o=void 0!==t&&null!==t&&t.length>0,u=void 0!==r&&null!==r&&r.length>0,c=void 0!==a&&null!==a&&a.length>0,l=void 0!==s&&null!==s&&s.length>0,!o||i.ArrayHelper.isTyped(t,b.Hash)){e.next=7;break}throw new S.BusinessError("The bundles must be an array of type Hash");case 7:if(!u||i.ArrayHelper.isTyped(r,h.Address)){e.next=9;break}throw new S.BusinessError("The addresses must be an array of type Address");case 9:if(!c||i.ArrayHelper.isTyped(a,m.Tag)){e.next=11;break}throw new S.BusinessError("The tags must be an array of type Tag");case 11:if(!l||i.ArrayHelper.isTyped(s,b.Hash)){e.next=13;break}throw new S.BusinessError("The approvees must be an array of type Hash");case 13:if(o||u||c||l){e.next=15;break}throw new S.BusinessError("You must provide bundles, addresses, tags or approvees");case 15:return f={bundles:o?t.map(function(e){return e.toTrytes().toString()}):void 0,addresses:u?r.map(function(e){return e.toTrytes().toString()}):void 0,tags:c?a.map(function(e){return e.toTrytes().toString()}):void 0,approvees:l?s.map(function(e){return e.toTrytes().toString()}):void 0},e.next=18,this._apiClient.findTransactions(f);case 18:if(!(d=e.sent)||!d.hashes){e.next=25;break}return p=d.hashes.map(function(e){return b.Hash.fromTrytes(k.Trytes.fromString(e))}),this._logger.info("<=== TransactionClient::findTransactions",p),e.abrupt("return",p);case 25:return this._logger.info("<=== TransactionClient::findTransactions",[]),e.abrupt("return",[]);case 27:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"getTransactionsObjects",value:function(){var e=a(n.default.mark(function e(t){var r,a,s;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::getTransactionsObjects",t),i.ArrayHelper.isTyped(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The transactionHashes must be an array of type Hash");case 3:return r={hashes:t.map(function(e){return e.toTrytes().toString()})},e.next=6,this._apiClient.getTrytes(r);case 6:if(!(a=e.sent)||!a.trytes){e.next=13;break}return s=a.trytes.map(function(e){return v.Transaction.fromTrytes(k.Trytes.fromString(e))}),this._logger.info("<=== TransactionClient::getTransactionsObjects",s),e.abrupt("return",s);case 13:return this._logger.info("<=== TransactionClient::getTransactionsObjects",[]),e.abrupt("return",[]);case 15:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getLatestInclusion",value:function(){var e=a(n.default.mark(function e(t){var r,a,s;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::transactionHashes"),i.ArrayHelper.isTyped(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The transactionHashes must be an array of type Hash");case 3:return e.next=5,this._apiClient.getNodeInfo();case 5:if(!(r=e.sent)||!o.NumberHelper.isInteger(r.latestSolidSubtangleMilestone)){e.next=20;break}return a={transactions:t.map(function(e){return e.toTrytes().toString()}),tips:[r.latestSolidSubtangleMilestone]},e.next=10,this._apiClient.getInclusionStates(a);case 10:if(!(s=e.sent)||!s.states){e.next=16;break}return this._logger.info("<=== TransactionClient::transactionHashes",s.states),e.abrupt("return",s.states);case 16:return this._logger.info("<=== TransactionClient::transactionHashes",[]),e.abrupt("return",[]);case 18:e.next=21;break;case 20:throw new S.BusinessError("The node could not provide the latestSolidSubtangleMilestone");case 21:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getNewAddress",value:function(){var t=a(n.default.mark(function t(r,a,s,i,c){var l,f,d,p,h;return n.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this._logger.info("===> TransactionClient::getNewAddress",r,a,s,i,c),u.ObjectHelper.isType(r,b.Hash)){t.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:if(u.ObjectHelper.isEmpty(a)||u.ObjectHelper.isType(a,Number)){t.next=5;break}throw new S.BusinessError("The startIndex must be an integer",{startIndex:a});case 5:if(!((l=a||0)<0)){t.next=8;break}throw new S.BusinessError("The startIndex must be >= 0",{localStartIndex:l});case 8:if(f=o.NumberHelper.isInteger(s),d=c||g.AddressSecurity.medium,!f){t.next=21;break}if(o.NumberHelper.isInteger(s)&&!(s<0)){t.next=13;break}throw new S.BusinessError("The endIndex must be a number >= 0",{endIndex:s});case 13:if(!((h=s-a+1)<=0||h>e.MAX_INPUTS)){t.next=16;break}throw new S.BusinessError("The total must be > 0 and <= ".concat(e.MAX_INPUTS),{total:h});case 16:return t.next=18,this.getAddressesByIndex(r,a,s,i,d);case 18:p=t.sent,t.next=24;break;case 21:return t.next=23,this.getAddressesToUnused(r,a,i,d);case 23:p=t.sent;case 24:return this._logger.info("<=== TransactionClient::getNewAddress",p),t.abrupt("return",p);case 26:case"end":return t.stop()}},t,this)}));return function(e,r,n,a,s){return t.apply(this,arguments)}}()},{key:"getAddressesByIndex",value:function(){var t=a(n.default.mark(function t(r,a,s,i,c){var l,f,d;return n.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this._logger.info("===> TransactionClient::getAddressesByIndex",r,a,s,i,c),u.ObjectHelper.isType(r,b.Hash)){t.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:if(o.NumberHelper.isInteger(a)&&!(a<0)){t.next=5;break}throw new S.BusinessError("The startIndex must be a number >= 0",{startIndex:a});case 5:if(o.NumberHelper.isInteger(s)&&!(s<0)){t.next=7;break}throw new S.BusinessError("The endIndex must be a number >= 0",{endIndex:s});case 7:if(!((l=s-a+1)<=0||l>e.MAX_INPUTS)){t.next=10;break}throw new S.BusinessError("The total must be > 0 and <= ".concat(e.MAX_INPUTS),{total:l});case 10:if(!(!o.NumberHelper.isInteger(c)||c<1||c>3)){t.next=12;break}throw new S.BusinessError("The security must be between 1 and 3",{security:c});case 12:for(f=[],d=0;d<l;d++)f.push(this.generateAddress(r,a+d,c,i));return this._logger.info("<=== TransactionClient::getAddressesByIndex",f),t.abrupt("return",Promise.resolve(f));case 16:case"end":return t.stop()}},t,this)}));return function(e,r,n,a,s){return t.apply(this,arguments)}}()},{key:"getAddressesToUnused",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var i,c,l,f,d,p,h,g,y;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::getAddressesToUnused",t,r,a,s),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:if(o.NumberHelper.isInteger(r)&&!(r<0)){e.next=5;break}throw new S.BusinessError("The startIndex must be a number >= 0",{startIndex:r});case 5:if(!(!o.NumberHelper.isInteger(s)||s<1||s>3)){e.next=7;break}throw new S.BusinessError("The security must be between 1 and 3",{security:s});case 7:i=r,l=[];case 9:return f=this.generateAddress(t,i++,s,a),l.push(f),d=f.toTrytes().toString(),p={addresses:[d]},e.next=15,this._apiClient.wereAddressesSpentFrom(p);case 15:if(h=e.sent,c=!!(h&&h.states&&h.states.length>0)&&h.states[0]){e.next=23;break}return g={addresses:[d]},e.next=21,this._apiClient.findTransactions(g);case 21:y=e.sent,c=y&&y.hashes&&y.hashes.length>0;case 23:if(c){e.next=9;break}case 24:return this._logger.info("<=== TransactionClient::getAddressesToUnused",l),e.abrupt("return",Promise.resolve(l));case 26:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"getInputs",value:function(){var e=a(n.default.mark(function e(t,r,a,s,i){var c,l,f,d,p,h,g,y;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::getInputs",t,r,a,s,i),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:if(o.NumberHelper.isInteger(r)&&!(r<0)){e.next=5;break}throw new S.BusinessError("The startIndex must be a number >= 0",{startIndex:r});case 5:if(!(!o.NumberHelper.isInteger(s)||s<1||s>3)){e.next=7;break}throw new S.BusinessError("The security must be between 1 and 3",{security:s});case 7:if(o.NumberHelper.isInteger(i)&&!(i<0)){e.next=9;break}throw new S.BusinessError("The totalRequired must be >= 0",{totalRequired:i});case 9:return e.next=11,this.getNewAddress(t,r,a,!1,s);case 11:return c=e.sent,l={addresses:c.map(function(e){return e.toTrytes().toString()}),threshold:100},e.next=15,this._apiClient.getBalances(l);case 15:if(f=e.sent,d=[],p=0,!f){e.next=30;break}h=0;case 20:if(!(h<c.length)){e.next=30;break}if(!((g=parseInt(f.balances[h],10))>0)){e.next=27;break}if(d.push(T.Input.fromParams(c[h],s,r+h,g)),p+=g,!(i>0&&p>=i)){e.next=27;break}return e.abrupt("break",30);case 27:h++,e.next=20;break;case 30:if(y={inputs:d,totalBalance:p},this._logger.info("<=== TransactionClient::getInputs",y),!(i>0&&p<i)){e.next=34;break}throw new S.BusinessError("Not enough combined balance in the addresses to satisfy the total required",{totalRequired:i,totalBalance:p});case 34:return e.abrupt("return",y);case 35:case"end":return e.stop()}},e,this)}));return function(t,r,n,a,s){return e.apply(this,arguments)}}()},{key:"prepareTransfers",value:function(){var t=a(n.default.mark(function t(r,a,s){var o,c,l,f,d,p,h,y,T,v,x,H,_,B,A,j;return n.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this._logger.info("===> TransactionClient::prepareTransfers",r,a,s),u.ObjectHelper.isType(r,b.Hash)){t.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:if(i.ArrayHelper.isTyped(a,w.Transfer)){t.next=5;break}throw new S.BusinessError("The transfers must be an array of Transfer objects");case 5:if((o=s||{}).security=o.security||g.AddressSecurity.medium,c=k.Trytes.fromString(""),l=!u.ObjectHelper.isEmpty(o.hmacKey),f=!1,a.forEach(function(t){t.message=t.message?t.message:c,t.tag=t.tag||m.Tag.EMPTY,l&&t.value>0&&(t.message=k.Trytes.fromString(e.NULL_HASH_TRYTES+t.message.toString()),f=!0)}),d=E.BundleHelper.prepareBundle(this._timeService,a),p=d.bundle,h=d.lastTag,y=d.totalValue,T=d.signatureMessageFragments,!(y>0)){t.next=49;break}if(!o.inputs){t.next=42;break}return v={addresses:o.inputs.map(function(e){return e.address.toTrytes().toString()}),threshold:100},t.next=21,this._apiClient.getBalances(v);case 21:x=t.sent,H=[],_=0,B=0;case 25:if(!(B<x.balances.length)){t.next=36;break}if(!((A=parseInt(x.balances[B],10))>0)){t.next=33;break}if(_+=A,o.inputs[B].balance=A,H.push(o.inputs[B]),!(_>=y)){t.next=33;break}return t.abrupt("break",36);case 33:B++,t.next=25;break;case 36:if(!(y>_)){t.next=38;break}throw new S.BusinessError("Not enough balance in the input addresses to satisfy the total for the transfer");case 38:return t.next=40,this.addRemainder(r,p,o,H,T,y,h,f);case 40:t.next=47;break;case 42:return t.next=44,this.getInputs(r,0,void 0,o.security,y);case 44:return j=t.sent,t.next=47,this.addRemainder(r,p,o,j.inputs,T,y,h,f);case 47:t.next=51;break;case 49:E.BundleHelper.finalizeBundle(p),p.addSignatureMessageFragments(T);case 51:return p.transactions=p.transactions.reverse(),this._logger.info("<=== TransactionClient::prepareTransfers",p),t.abrupt("return",p);case 54:case"end":return t.stop()}},t,this)}));return function(e,r,n){return t.apply(this,arguments)}}()},{key:"attachToTangle",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var c,l,f,d,p;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::attachToTangle",t,r,a,s),u.ObjectHelper.isType(t,y.Bundle)){e.next=3;break}throw new S.BusinessError("The bundle must be an array of type Bundle");case 3:if(i.ArrayHelper.isTyped(t.transactions,v.Transaction)){e.next=5;break}throw new S.BusinessError("The bundle.transactions must be an array of type Transaction");case 5:if(o.NumberHelper.isInteger(r)&&!(r<=0)){e.next=7;break}throw new S.BusinessError("The depth must be a number > 0",{depth:r});case 7:if(o.NumberHelper.isInteger(a)&&!(a<=0)){e.next=9;break}throw new S.BusinessError("The minWeightMagnitude must be a number > 0",{minWeightMagnitude:a});case 9:return c={depth:r,reference:s?s.toTrytes().toString():void 0},e.next=12,this._apiClient.getTransactionsToApprove(c);case 12:return l=e.sent,e.next=15,this._proofOfWork.pow(b.Hash.fromTrytes(k.Trytes.fromString(l.trunkTransaction)),b.Hash.fromTrytes(k.Trytes.fromString(l.branchTransaction)),t.transactions.map(function(e){return e.toTrytes()}),a);case 15:return f=e.sent,d=f.map(function(e){return v.Transaction.fromTrytes(e)}),(p=new y.Bundle).transactions=d,this._logger.info("<=== TransactionClient::attachToTangle",p),e.abrupt("return",p);case 21:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"sendTransactions",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var i,o,u;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._logger.info("===> TransactionClient::sendTransactions",t,r,a,s),e.next=3,this.attachToTangle(t,r,a,s);case 3:return i=e.sent,o={trytes:i.transactions.map(function(e){return e.toTrytes().toString()})},e.next=7,this._apiClient.storeTransactions(o);case 7:return u={trytes:o.trytes},e.next=10,this._apiClient.broadcastTransactions(u);case 10:return this._logger.info("<=== TransactionClient::sendTransactions",i),e.abrupt("return",i);case 12:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"sendTransfer",value:function(){var e=a(n.default.mark(function e(t,r,a,s,i,o){var u,c;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._logger.info("===> TransactionClient::sendTransfer",t,r,a,s,i,o),e.next=3,this.prepareTransfers(t,s,i);case 3:return u=e.sent,e.next=6,this.sendTransactions(u,r,a,o);case 6:return c=e.sent,this._logger.info("<=== TransactionClient::sendTransfer",c),e.abrupt("return",c);case 9:case"end":return e.stop()}},e,this)}));return function(t,r,n,a,s,i){return e.apply(this,arguments)}}()},{key:"isPromotable",value:function(){var e=a(n.default.mark(function e(t){var r,a;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::isPromotable",t),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The transactionTail must be an object of type Hash");case 3:return r={tails:[t.toTrytes().toString()]},e.next=6,this._apiClient.checkConsistency(r);case 6:return a=e.sent,this._logger.info("<=== TransactionClient::isPromotable",a.state),e.abrupt("return",a.state);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"isReattachable",value:function(){var e=a(n.default.mark(function e(t){var r,a,s,o,u,c,l,f;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::isReattachable",t),i.ArrayHelper.isTyped(t,h.Address)){e.next=3;break}throw new S.BusinessError("The addresses must be an object of type Address");case 3:for(r={},a=0;a<t.length;a++)s=t[a].toTrytes().toString(),r[s]=[];return e.next=7,this.findTransactionObjects(void 0,t);case 7:if(o=e.sent,u=[],o.forEach(function(e){if(e.value.toNumber()<0){var t=e.address,n=p.TransactionHelper.hash(e);r[t.toTrytes().toString()].push(n),u.push(n)}}),!(u.length>0)){e.next=17;break}return e.next=13,this.getLatestInclusion(u);case 13:l=e.sent,c=t.map(function(e){for(var t=!0,n=r[e.toTrytes().toString()],a=0;a<n.length;a++){var s=u.indexOf(n[a]);if(!(t=!l[s]))break}return t}),e.next=19;break;case 17:for(c=[],f=0;f<t.length;f++)c.push(!0);case 19:return this._logger.info("<=== TransactionClient::isReattachable",c),e.abrupt("return",c);case 21:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"promoteTransaction",value:function(){var e=a(n.default.mark(function e(t,r,s,c,l){var f,d,p=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::promoteTransaction",t,r,s,c,l),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The transactionTail must be an object of type Hash");case 3:if(o.NumberHelper.isInteger(r)&&!(r<=0)){e.next=5;break}throw new S.BusinessError("The depth must be a number > 0",{depth:r});case 5:if(o.NumberHelper.isInteger(s)&&!(s<=0)){e.next=7;break}throw new S.BusinessError("The minWeightMagnitude must be a number > 0",{minWeightMagnitude:s});case 7:if(i.ArrayHelper.isTyped(c,w.Transfer)){e.next=9;break}throw new S.BusinessError("The transfers must an array of Transfer objects");case 9:if(f=l||{},u.ObjectHelper.isEmpty(f.interrupt)&&(f.interrupt=!1),!1!==f.interrupt&&("function"!=typeof f.interrupt||f.interrupt())){e.next=30;break}return e.next=14,this.isPromotable(t);case 14:if(!e.sent){e.next=27;break}return e.next=18,this.sendTransfer(b.Hash.fromTrytes(c[0].address.toTrytes()),r,s,c,void 0,t);case 18:if(d=e.sent,!o.NumberHelper.isInteger(f.delay)){e.next=23;break}return e.abrupt("return",this._backgroundTaskService.create(a(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",p.promoteTransaction(t,r,s,c,f));case 1:case"end":return e.stop()}},e,this)})),f.delay));case 23:return this._logger.info("<=== TransactionClient::promoteTransaction",d),e.abrupt("return",d);case 25:e.next=28;break;case 27:throw new S.BusinessError("Transaction is not promotable");case 28:e.next=32;break;case 30:return this._logger.info("<=== TransactionClient::promoteTransaction",void 0),e.abrupt("return",void 0);case 32:case"end":return e.stop()}},e,this)}));return function(t,r,n,a,s){return e.apply(this,arguments)}}()},{key:"getBundle",value:function(){var e=a(n.default.mark(function e(t){var r,a;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::getBundle",t),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The transactionHash must be an object of type Hash");case 3:return e.next=5,this.traverseBundle(t);case 5:if(r=e.sent,(a=new y.Bundle).transactions=r,E.BundleHelper.isValid(a)){e.next=11;break}throw new S.BusinessError("Invalid bundle provided");case 11:return this._logger.info("<=== TransactionClient::getBundle",a),e.abrupt("return",a);case 13:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"traverseBundle",value:function(){var e=a(n.default.mark(function e(t,r){var a,s,i,o,c,l,f,d,p;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::traverseBundle",t,r),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The trunkTransaction must be an object of type Hash");case 3:a=[],s=t,i=r;case 6:return o={hashes:[s.toTrytes().toString()]},e.next=9,this._apiClient.getTrytes(o);case 9:if(c=e.sent,l=!u.ObjectHelper.isEmpty(c)&&!u.ObjectHelper.isEmpty(c.trytes)&&c.trytes.length>0?c.trytes[0]:void 0,!u.ObjectHelper.isEmpty(l)){e.next=15;break}throw new S.BusinessError("Bundle transactions not visible");case 15:if(f=v.Transaction.fromTrytes(k.Trytes.fromString(l)),(d=!u.ObjectHelper.isEmpty(i))||0===f.currentIndex.toNumber()){e.next=19;break}throw new S.BusinessError("Invalid tail transaction supplied");case 19:p=d?i:f.bundle,s=void 0,i=void 0,p.toTrytes().toString()===f.bundle.toTrytes().toString()&&(a.push(f),0===f.lastIndex.toNumber()&&0===f.currentIndex.toNumber()||(s=f.trunkTransaction,i=p));case 23:if(void 0!==s){e.next=6;break}case 24:return this._logger.info("<=== TransactionClient::traverseBundle",a),e.abrupt("return",a);case 26:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"reattachBundle",value:function(){var e=a(n.default.mark(function e(t,r,a){var s,i;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._logger.info("===> TransactionClient::reattachBundle",t,r,a),e.next=3,this.getBundle(t);case 3:return(s=e.sent).transactions=s.transactions.reverse(),e.next=7,this.sendTransactions(s,r,a);case 7:return i=e.sent,this._logger.info("<=== TransactionClient::reattachBundle",i),e.abrupt("return",i);case 10:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"rebroadcastBundle",value:function(){var e=a(n.default.mark(function e(t){var r,a;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._logger.info("===> TransactionClient::rebroadcastBundle",t),e.next=3,this.getBundle(t);case 3:return r=e.sent,a={trytes:r.transactions.reverse().map(function(e){return e.toTrytes().toString()})},e.next=7,this._apiClient.broadcastTransactions(a);case 7:return this._logger.info("<=== TransactionClient::rebroadcastBundle",r),e.abrupt("return",r);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"findTransactionObjects",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var i,o;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._logger.info("===> TransactionClient::findTransactionObjects",t,r,a,s),e.next=3,this.findTransactions(t,r,a,s);case 3:if(!((i=e.sent).length>0)){e.next=12;break}return e.next=7,this.getTransactionsObjects(i);case 7:return o=e.sent,this._logger.info("<=== TransactionClient::findTransactionObjects",o),e.abrupt("return",o);case 12:return this._logger.info("<=== TransactionClient::findTransactionObjects",[]),e.abrupt("return",[]);case 14:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"getTransfers",value:function(){var e=a(n.default.mark(function e(t,r,a,s,i){var c,l,f;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::getTransfers",t,r,a,s,i),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:return c=r,o.NumberHelper.isInteger(c)||(c=0),e.next=7,this.getNewAddress(t,c,a,!1,s);case 7:return l=e.sent,e.next=10,this.bundlesFromAddresses(l,i);case 10:return f=e.sent,this._logger.info("<=== TransactionClient::getTransfers",f),e.abrupt("return",f);case 13:case"end":return e.stop()}},e,this)}));return function(t,r,n,a,s){return e.apply(this,arguments)}}()},{key:"getAccountData",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var i,c,l,f,d,p,h,y;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._logger.info("===> TransactionClient::getAccountData",t,r,a,s),u.ObjectHelper.isType(t,b.Hash)){e.next=3;break}throw new S.BusinessError("The seed must be of type Hash");case 3:return i=r,o.NumberHelper.isInteger(i)||(i=0),e.next=7,this.getNewAddress(t,i,a,!1,s||g.AddressSecurity.medium);case 7:return c=e.sent,e.next=10,this.bundlesFromAddresses(c,!0);case 10:return l=e.sent,f={latestAddress:c.pop(),addresses:c,transfers:l,inputs:[],balance:0},d={addresses:f.addresses.map(function(e){return e.toTrytes().toString()}),threshold:100},e.next=15,this._apiClient.getBalances(d);case 15:for(p=e.sent,h=0;h<p.balances.length;h++)(y=parseInt(p.balances[h],10))>0&&(f.inputs.push(T.Input.fromParams(f.addresses[h],s||g.AddressSecurity.medium,i+h,y)),f.balance+=y);return this._logger.info("<=== TransactionClient::getAccountData",f),e.abrupt("return",f);case 19:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"bundlesFromAddresses",value:function(){var e=a(n.default.mark(function e(t,r){var a,s,i,o,u,c,l,f;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.findTransactionObjects(void 0,t,void 0,void 0);case 2:if(a=e.sent,s=new Set,i=new Set,a.forEach(function(e){0===e.currentIndex.toNumber()?s.add(p.TransactionHelper.hash(e).toTrytes().toString()):i.add(e.bundle.toTrytes().toString())}),!(i.size>0)){e.next=11;break}return e.next=9,this.findTransactionObjects(Array.from(i).map(function(e){return b.Hash.fromTrytes(k.Trytes.fromString(e))}));case 9:e.sent.forEach(function(e){0===e.currentIndex.toNumber()&&s.add(p.TransactionHelper.hash(e).toTrytes().toString())});case 11:if(o=[],u=Array.from(s),!r){e.next=17;break}return e.next=16,this.getLatestInclusion(u.map(function(e){return b.Hash.fromTrytes(k.Trytes.fromString(e))}));case 16:c=e.sent;case 17:l=0;case 18:if(!(l<u.length)){e.next=27;break}return e.next=21,this.getBundle(b.Hash.fromTrytes(k.Trytes.fromString(u[l])));case 21:(f=e.sent).inclusionState=c?c[l]:void 0,o.push(f);case 24:l++,e.next=18;break;case 27:return o.sort(function(e,t){var r=e.transactions[0].attachmentTimestamp.toNumber(),n=t.transactions[0].attachmentTimestamp.toNumber();return r<n?-1:r>n?1:0}),e.abrupt("return",o);case 29:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"generateAddress",value:function(e,t,r,n){var a=d.ISS.key(e,t,r),s=d.ISS.digests(a),i=d.ISS.address(s),o=x.Trits.fromArray(i).toTrytes().toString();return n&&(o+=H.AddressHelper.createChecksum(i,9)),h.Address.fromTrytes(k.Trytes.fromString(o))}},{key:"addRemainder",value:function(){var e=a(n.default.mark(function e(t,r,a,s,i,o,c,l){var f,d,p,g,y,b,T,m;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:f=o,d=0;case 2:if(!(d<s.length)){e.next=31;break}if(p=Math.floor(this._timeService.msSinceEpoch()/1e3),r.addTransactions(s[d].security,s[d].address,-s[d].balance,c,p),!(s[d].balance>=f)){e.next=27;break}if(!((g=s[d].balance-f)>0&&!u.ObjectHelper.isEmpty(a)&&u.ObjectHelper.isType(a.remainderAddress,h.Address))){e.next=12;break}r.addTransactions(1,a.remainderAddress,g,c,p),E.BundleHelper.signInputs(t,r,a,i,s,l),e.next=25;break;case 12:if(!(g>0)){e.next=24;break}for(y=0,b=0;b<s.length;b++)y=Math.max(s[b].keyIndex,y);return y++,e.next=18,this.getAddressesToUnused(t,y,!1,a.security);case 18:T=e.sent,m=Math.floor(this._timeService.msSinceEpoch()/1e3),r.addTransactions(1,T[T.length-1],g,c,m),E.BundleHelper.signInputs(t,r,a,i,s,l),e.next=25;break;case 24:E.BundleHelper.signInputs(t,r,a,i,s,l);case 25:e.next=28;break;case 27:f-=s[d].balance;case 28:d++,e.next=2;break;case 31:case"end":return e.stop()}},e,this)}));return function(t,r,n,a,s,i,o,u){return e.apply(this,arguments)}}()}]),e}();B.NULL_HASH_TRYTES="9".repeat(243),B.MAX_INPUTS=500,t.TransactionClient=B},function(e,t){e.exports=b},function(e,t){e.exports=T},function(e,t){e.exports=m},function(e,t){e.exports=v},function(e,t){e.exports=w},function(e,t,r){"use strict";var n=function(e){return e&&e.__esModule?e:{default:e}}(r(14));function a(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var s=e.apply(t,r);function i(e,t){try{var r=s[e](t),i=r.value}catch(e){return void a(e)}r.done?n(i):Promise.resolve(i).then(o,u)}function o(e){i("next",e)}function u(e){i("throw",e)}o()})}}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}Object.defineProperty(t,"__esModule",{value:!0});var i=r(3),o=r(15),u=r(4),c=r(34),l=r(7),f=r(1),d=r(2),p=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u.ObjectHelper.isEmpty(t))throw new d.BusinessError("The apiClient must not be empty");this._apiClient=t}return function(e,t,r){t&&s(e.prototype,t)}(e,[{key:"initialize",value:function(){var e=a(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.resolve());case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"pow",value:function(){var e=a(n.default.mark(function e(t,r,a,s){var d,p;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(u.ObjectHelper.isType(t,l.Hash)){e.next=2;break}throw new c.CryptoError("The trunkTransaction must be an object of type Hash");case 2:if(u.ObjectHelper.isType(r,l.Hash)){e.next=4;break}throw new c.CryptoError("The branchTransaction must be an object of type Hash");case 4:if(i.ArrayHelper.isTyped(a,f.Trytes)){e.next=6;break}throw new c.CryptoError("The trytes must be an array of type Trytes");case 6:if(o.NumberHelper.isInteger(s)&&!(s<=0)){e.next=8;break}throw new c.CryptoError("The minWeightMagnitude must be > 0");case 8:return d={trunkTransaction:t.toString(),branchTransaction:r.toString(),minWeightMagnitude:s,trytes:a.map(function(e){return e.toString()})},e.next=11,this._apiClient.attachToTangle(d);case 11:if(p=e.sent,!u.ObjectHelper.isEmpty(p)&&!i.ArrayHelper.isEmpty(p.trytes)){e.next=16;break}throw new c.CryptoError("The attachToTangleRequest did not return any trytes");case 16:return e.abrupt("return",p.trytes.map(function(e){return f.Trytes.fromString(e)}));case 17:case"end":return e.stop()}},e,this)}));return function(t,r,n,a){return e.apply(this,arguments)}}()}]),e}();t.ProofOfWorkApi=p},function(e,t){e.exports=x}])});